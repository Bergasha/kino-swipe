<!DOCTYPE html>
<html>
<head>
    <title>Kino-Swipe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#111111">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kino-Swipe">
    <link rel="apple-touch-icon" href="/static/main.png">

    <style>
        /* Version: 1.2.1 - Matches & Layout Fix */
        @import url('https://fonts.googleapis.com/css2?family=Allura&display=swap');
        
        body { background: #111; color: white; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .plex-yellow { color: #e5a00d; }
        .menu-btn { background: #e5a00d; border: none; padding: 15px; font-size: 1.2rem; border-radius: 8px; cursor: pointer; margin: 10px; font-weight: bold; width: 220px; color: black; }
        
        #main-menu { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .main-logo { width: 180px; height: auto; margin-bottom: 10px; }
        .main-title { font-size: 4.0rem; margin: 0 0 30px 0; font-weight: bold; color: #8a0606; font-family: 'allura', cursive; }
        
        #game-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: #111; z-index: 100; }
        #swipe-deck { position: relative; width: 100%; max-width: 380px; margin: 15px auto 100px auto; height: 68vh; }
        
        .movie-card, .mini-poster { perspective: 1000px; }
        .card-inner, .mini-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flipped .card-inner, .flipped .mini-inner { transform: rotateY(180deg); }
        .card-front, .card-back, .mini-front, .mini-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 20px; overflow: hidden;
        }
        .card-back, .mini-back { transform: rotateY(180deg); background: #1a1a1a; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box; border: 2px solid #e5a00d; }

        .movie-card { position: absolute; width: 90%; height: 100%; left: 5%; top: 0; touch-action: none; z-index: 5; }
        .movie-card img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
        .movie-info { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.8) 40%, rgba(0,0,0,1)); padding: 30px 15px 15px; box-sizing: border-box; pointer-events: none; }
        .movie-title { font-size: 1.4rem; font-weight: bold; color: #e5a00d; margin-bottom: 5px; }
        .movie-synopsis { font-size: 0.85rem; line-height: 1.3; color: #ccc; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        #matches-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 20000; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        #matches-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; overflow-y: auto; padding-bottom: 120px; }
        
        .mini-poster { width: 100%; aspect-ratio: 2/3; border-radius: 10px; }
        .mini-front img { width: 100%; height: 100%; object-fit: cover; }
        .mini-front { border: 2px solid #333; }
        .mini-back { padding: 10px; border-radius: 10px; }
        
        .plex-open-btn { background: #e5a00d; color: black; border: none; padding: 10px 5px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; cursor: pointer; text-decoration: none; width: 90%; margin-top: 10px; display: block; text-align: center; }
        .mini-title-text { font-size: 0.8rem; font-weight: bold; color: white; text-align: center; }

        .stats-row { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .stat-badge { background: black; color: #e5a00d; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 0.8rem; }
        
        .back-content { overflow-y: auto; flex-grow: 1; margin-bottom: 10px; }
        .back-content p { font-size: 0.95rem; line-height: 1.5; color: #eee; margin: 0; }

        .glow-side { position: absolute; top: 0; width: 40%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 0.2s; }
        #glow-left { left: 0; background: linear-gradient(to right, rgba(211, 47, 47, 0.6), transparent); }
        #glow-right { right: 0; background: linear-gradient(to left, rgba(76, 175, 80, 0.6), transparent); }

        .pill-btn { position: fixed; bottom: 25px; width: 120px; height: 45px; border-radius: 30px; border: none; font-weight: bold; font-size: 0.9rem; z-index: 9999; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        #matches-pill { right: 20px; background: #e5a00d; color: black; }
        #quit-pill { left: 20px; background: #d32f2f; color: black; }
        
        #undo-btn { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #a64703; width: 65px; height: 65px; border-radius: 50%; border: 3px solid #a64703; font-size: 1.0rem; z-index: 9999; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.8); }
        
        #match-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 15000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .match-logo { width: 150px; margin-bottom: 20px; }

        .match-instruction { position: fixed; bottom: 85px; color: #888; font-size: 0.9rem; font-style: italic; z-index: 20001; }
    </style>
</head>
<body>
    <button id="matches-pill" class="pill-btn hidden">Matches</button>
    <button id="quit-pill" class="pill-btn hidden" onclick="confirmQuit()">End Session</button>
    <button id="undo-btn" class="hidden">Undo</button>

    <div id="login-section">
        <img src="/static/main.png" class="main-logo" style="margin-top:50px;">
        <h1 class="main-title plex-yellow">Kino-Swipe</h1>
        <button id="login-btn" class="menu-btn" onclick="loginWithPlex()">Login with Plex</button>
    </div>

    <div id="main-menu" class="hidden">
        <div id="branding">
            <img src="/static/main.png" class="main-logo">
            <h1 class="main-title plex-yellow">Kino-Swipe</h1>
        </div>
        <div id="controls-area">
            <button id="host-btn" class="menu-btn">Host Session</button>
            <div id="session-info" class="hidden">
                <p>Code: <span id="session-display" class="plex-yellow" style="font-size: 2.5rem;">----</span></p>
                <p>Waiting for partner...</p>
            </div>
            <div style="margin-top:20px;">
                <hr style="border:0; border-top:1px solid #333; width: 220px; margin: 10px auto;">
                <input type="text" id="join-code" inputmode="numeric" maxlength="4" placeholder="Enter Code" style="padding:15px; width:180px; text-align:center; border-radius:8px; border:1px solid #444; background:#222; color:white; font-size:1.2rem;">
                <br>
                <button id="join-btn" class="menu-btn" onclick="joinRoom()">Join Session</button>
                <br>
                <button onclick="localStorage.clear(); location.reload();" style="background:none; border:none; color:#444; text-decoration:underline; cursor:pointer; margin-top:20px;">Logout</button>
            </div>
        </div>
        <div id="game-area" class="hidden">
            <div id="glow-left" class="glow-side"></div>
            <div id="glow-right" class="glow-side"></div>
            <div id="swipe-deck"></div>
        </div>
    </div>

    <div id="match-overlay" class="hidden">
        <img src="/static/logo.png" class="match-logo">
        <h1 class="plex-yellow" style="font-size: 3.5rem; margin: 0;">MATCH!</h1>
        <h2 id="matched-movie-title" style="margin: 10px 0 30px; padding:0 20px;"></h2>
        <button class="menu-btn" onclick="document.getElementById('match-overlay').classList.add('hidden')">Keep Swiping</button>
    </div>

    <div id="matches-modal" class="hidden">
        <h1 class="plex-yellow">Your Matches</h1>
        <div id="matches-list"></div>
        <div class="match-instruction">Click on each match for more options</div>
        <button class="menu-btn" style="position: fixed; bottom: 20px; width: 150px; z-index:20001;" onclick="document.getElementById('matches-modal').classList.add('hidden')">Close</button>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("/sw.js");
        }

        let movieStack = [];
        let swipeHistory = [];
        let pollingInterval = null;
        let globalCurrentX = 0;
        let plexServerId = null;

        async function fetchPlexServerId() {
            if (plexServerId) return plexServerId;
            const response = await fetch('/plex/server-info');
            if (response.ok) {
                const data = await response.json();
                plexServerId = data.machineIdentifier;
                return plexServerId;
            }
            return null;
        }

        async function loginWithPlex() {
            const resp = await fetch("/auth/plex-url");
            const data = await resp.json();
            window.location.href = data.auth_url;
        }

        async function confirmQuit() {
            if (confirm("End session and delete ALL matches?")) {
                await fetch('/room/quit', { method: 'POST' });
                localStorage.removeItem('active_room');
                location.reload();
            }
        }

        async function addToWatchlist(event, id) {
            event.stopPropagation();
            const btn = event.currentTarget;
            const originalText = btn.innerText;
            btn.innerText = "ADDING...";
            btn.disabled = true;

            try {
                const res = await fetch("/watchlist/add", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "X-Plex-Token": localStorage.getItem('plex_token')
                    },
                    body: JSON.stringify({ movie_id: id })
                });

                if (res.ok) {
                    btn.innerText = "IN WATCHLIST";
                    btn.style.borderColor = "#4CAF50";
                    btn.style.color = "#4CAF50";
                } else {
                    btn.innerText = "FAILED";
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (err) {
                btn.innerText = "ERROR";
            }
        }

        const loadMovies = async () => {
            const res = await fetch('/movies');
            movieStack = await res.json();
            document.getElementById('branding').classList.add('hidden');
            document.getElementById('controls-area').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('matches-pill').classList.remove('hidden');
            document.getElementById('quit-pill').classList.remove('hidden');
            document.getElementById('undo-btn').classList.remove('hidden');
            renderInitialDeck();
        };

        async function updateMatchesUI() {
            const serverId = await fetchPlexServerId();
            if (!serverId) {
                console.error('Could not get Plex server ID');
                return;
            }
            
            const res = await fetch('/matches');
            const data = await res.json();
            const list = document.getElementById('matches-list');
            list.innerHTML = data.length ? '' : '<p style="grid-column: span 2;">No matches yet</p>';
            
            data.forEach(m => {
                const card = document.createElement('div');
                card.className = 'mini-poster';
                const plexLink = `https://app.plex.tv/desktop/#!/server/${serverId}/details?key=%2Flibrary%2Fmetadata%2F${m.movie_id}`;

                card.innerHTML = `
                    <div class="mini-inner">
                        <div class="mini-front">
                            <img src="${m.thumb}" alt="${m.title}">
                            <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); font-size:10px; padding:4px;">${m.title}</div>
                        </div>
                        <div class="mini-back">
                            <div class="mini-title-text">${m.title}</div>
                            <a href="${plexLink}" class="plex-open-btn" target="_blank" rel="noopener noreferrer">OPEN IN PLEX</a>
                            <button class="menu-btn" style="width:90%; padding:8px; font-size:0.7rem; background:#333; color:#e5a00d; border:1px solid #e5a00d; margin-top:5px;" onclick="addToWatchlist(event, '${m.movie_id}')">+ WATCHLIST</button>
                            <button class="menu-btn" style="width:90%; padding:8px; font-size:0.7rem; background:#d32f2f; margin-top:5px; color:black;" onclick="deleteMatch(event, '${m.movie_id}')">DELETE</button>
                        </div>
                    </div>
                `;
                
                card.onclick = (e) => {
                    if (e.target.closest('a') || e.target.closest('button')) return;
                    card.classList.toggle('flipped');
                };
                list.appendChild(card);
            });
        }

        async function deleteMatch(event, id) {
            event.stopPropagation();
            if (confirm("Delete match for everyone?")) {
                await fetch("/matches/delete", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ movie_id: id }) });
                updateMatchesUI();
            }
        }

        document.getElementById('undo-btn').onclick = async () => {
            if (swipeHistory.length === 0) return;
            const lastMovie = swipeHistory.pop();
            await fetch('/undo', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ movie_id: lastMovie.id }) });
            movieStack.unshift(lastMovie);
            renderInitialDeck();
        };

        document.getElementById('matches-pill').onclick = () => { 
            updateMatchesUI(); 
            document.getElementById('matches-modal').classList.remove('hidden'); 
        };

        function renderInitialDeck() {
            const deck = document.getElementById('swipe-deck');
            deck.innerHTML = '';
            movieStack.slice(0, 5).reverse().forEach(m => deck.appendChild(createCard(m)));
            initDrag(deck.lastElementChild);
        }

        function createCard(m) {
            const c = document.createElement('div');
            c.className = 'movie-card';
            c.dataset.id = m.id;
            c.dataset.title = m.title;
            c.dataset.thumb = m.thumb;

            c.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">
                        <img src="${m.thumb}">
                        <div class="movie-info">
                            <div class="movie-title">${m.title}</div>
                            <div class="movie-synopsis">${m.summary || ''}</div>
                        </div>
                    </div>
                    <div class="card-back">
                        <div class="movie-title">${m.title}</div>
                        <div class="stats-row">
                            ${m.rating ? `<span class="stat-badge">IMDb ${m.rating}</span>` : ''}
                            ${m.duration ? `<span class="stat-badge">${m.duration}</span>` : ''}
                        </div>
                        <div class="back-content">
                            <p>${m.summary || 'No description available.'}</p>
                        </div>
                        <div style="font-size:0.75rem; color:#e5a00d; text-align:center; margin-top: auto;">Tap to flip back</div>
                    </div>
                </div>
            `;

            c.addEventListener('click', () => {
                if (Math.abs(globalCurrentX) < 5) {
                    c.classList.toggle('flipped');
                }
            });

            return c;
        }

        function initDrag(card) {
            if (!card) return;
            let startX, isDragging = false;
            globalCurrentX = 0;
            const glowLeft = document.getElementById('glow-left');
            const glowRight = document.getElementById('glow-right');

            const onMove = (e) => {
                if (!isDragging) return;
                const x = e.clientX || (e.touches && e.touches[0].clientX);
                globalCurrentX = x - startX;
                
                if (card.classList.contains('flipped')) return;

                card.style.transition = 'none';
                card.style.transform = `translate(${globalCurrentX}px, ${Math.abs(globalCurrentX)/10}px) rotate(${globalCurrentX / 10}deg)`;

                if (globalCurrentX > 20) {
                    glowRight.style.opacity = Math.min(Math.abs(globalCurrentX) / 200, 1);
                    glowLeft.style.opacity = 0;
                } else if (globalCurrentX < -20) {
                    glowLeft.style.opacity = Math.min(Math.abs(globalCurrentX) / 200, 1);
                    glowRight.style.opacity = 0;
                } else {
                    glowLeft.style.opacity = 0;
                    glowRight.style.opacity = 0;
                }
            };

            const onEnd = async () => {
                if (!isDragging) return; isDragging = false;
                glowLeft.style.opacity = 0;
                glowRight.style.opacity = 0;
                
                if (card.classList.contains('flipped')) {
                    globalCurrentX = 0;
                    return;
                }

                card.style.transition = 'transform 0.4s ease, opacity 0.3s ease';
                
                if (Math.abs(globalCurrentX) > 120) {
                    const dir = globalCurrentX > 0 ? 'right' : 'left';
                    card.style.transform = `translate(${globalCurrentX > 0 ? 1000 : -1000}px, 0px) rotate(${globalCurrentX / 5}deg)`;
                    card.style.opacity = '0';
                    const movieData = movieStack[0];
                    swipeHistory.push(movieData);
                    fetch('/room/swipe', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ 
                            movie_id: card.dataset.id, 
                            title: card.dataset.title, 
                            thumb: card.dataset.thumb, 
                            direction: dir 
                        }) 
                    })
                    .then(r => r.json())
                    .then(data => { 
                        if (data.match) { 
                            document.getElementById('matched-movie-title').innerText = data.title; 
                            document.getElementById('match-overlay').classList.remove('hidden'); 
                        } 
                    });

                    setTimeout(() => { 
                        card.remove(); 
                        movieStack.shift(); 
                        if (movieStack[4]) document.getElementById('swipe-deck').prepend(createCard(movieStack[4])); 
                        initDrag(document.getElementById('swipe-deck').lastElementChild); 
                        globalCurrentX = 0;
                    }, 300);
                } else { 
                    card.style.transform = ''; 
                    setTimeout(() => globalCurrentX = 0, 50);
                }
            };
            
            card.onpointerdown = (e) => {
                if (e.target.tagName === 'BUTTON') return;
                isDragging = true;
                startX = e.clientX || (e.touches && e.touches[0].clientX);
                card.setPointerCapture(e.pointerId);
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', onEnd);
            };
        }

        document.getElementById('host-btn').onclick = async () => {
            const res = await fetch('/room/create', { method: 'POST' });
            const data = await res.json();
            localStorage.setItem('active_room', 'hosting'); 
            document.getElementById('session-display').innerText = data.pairing_code;
            document.getElementById('host-btn').classList.add('hidden');
            document.getElementById('session-info').classList.remove('hidden');
            startPolling();
        };

        async function joinRoom() {
            const code = document.getElementById('join-code').value;
            const res = await fetch('/room/join', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code }) });
            if (res.ok) {
                localStorage.setItem('active_room', 'joined');
                loadMovies();
            } else {
                alert("Invalid Code");
            }
        }

        const startPolling = () => {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                const s = await fetch('/room/status');
                const d = await s.json();
                if (d.ready) { clearInterval(pollingInterval); loadMovies(); }
            }, 3000);
        };

        window.onload = async () => {
            const pendingPin = await fetch("/auth/check-returned-pin");
            const result = await pendingPin.json();
            if (result.authToken) {
                localStorage.setItem("plex_token", result.authToken);
            }
            if (localStorage.getItem('plex_token')) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-menu').classList.remove('hidden');
                if (localStorage.getItem('active_room')) loadMovies();
            }
        };
    </script>
</body>
</html>
